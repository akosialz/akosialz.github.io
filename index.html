<!DOCTYPE html>
<html>

<head>
    <title>Simple Map</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <meta name="google-signin-client_id" content="76014849832-k75b29ac0ubr73hdlpp4ajlbt8entjre.apps.googleusercontent.com"></meta>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
        
        #map {
            height: 100%;
        }
        /* Optional: Makes the sample page fill the window. */
        
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>

    <script type="text/javascript">
		
        var currentPosition;
		
        var map;
        var searchbox;
		var ddl;
		var ddlChart;
        var searchCoord;
        var toggleRestaurant;
        var drawingManager;
		
        var selectedShape;	// current selected shape
        var directionsDisplay;
		
        var nearbyMarkers = [];	// all nearby markers based from nearby place search
        var all_overlays = [];	// all polygons
        var containedMarkers = [];	// all markers in the circle
		
        var discoveryUrl = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
		var chartHead = ['Company', '2014', '2015', '2016'];
		
		// containers
		var fetchedStatistics = [];	// from reading sheets
		var storeStatistics = [];	// from nearby place search
		var finalStatistics = [];	// clean array gathered from reading and from nearby palce search

        // Your Client ID can be retrieved from your project in the Google
        // Developer Console, https://console.developers.google.com
        var CLIENT_ID = '76014849832-k75b29ac0ubr73hdlpp4ajlbt8entjre.apps.googleusercontent.com';

        var SCOPES = ["https://www.googleapis.com/auth/spreadsheets"];

        function checkAuth() {
            gapi.auth.authorize({
                'client_id': CLIENT_ID,
                'scope': SCOPES.join(' '),
                'immediate': true
            }, handleAuthResult);
        }

        function handleAuthResult(authResult) {
            var authorizeDiv = document.getElementById('authorize-div');
            if (authResult && !authResult.error) {
                // Hide auth UI, then load client library.
                authorizeDiv.style.display = 'none';
                loadSheetsApi(0);
            } else {
                // Show auth UI, allowing the user to initiate authorization by
                // clicking authorize button.
                authorizeDiv.style.display = 'inline';
            }
        }

        function handleAuthClick() {
            gapi.auth.authorize({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    immediate: false
                }, handleAuthResult);
        }

        function loadSheetsApi(method) {
			if (method == 0) gapi.client.load(discoveryUrl).then(listAllContents);
			else if (method == 1) gapi.client.load(discoveryUrl).then(storeContents);
        }
		
        function listAllContents() {
            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: '1ANh8ZoIjfqypndns_oI3xK1j1Pf0Nc0dLMLgJ2IxZcU',
                range: 'Restaurants!A2:N',
            }).then(function(response) {
				fetchedStatistics = [];
				if (response.result.values != null &&  response.result.values.length > 0)  {
					fetchedStatistics = response.result.values.splice(0);
				}
				
				storeContents();
            }, function(response) {
                alert('Error: ' + response.result.error.message);
            });
        }

        function storeContents() {
            gapi.client.sheets.spreadsheets.values.append({
                spreadsheetId: '1ANh8ZoIjfqypndns_oI3xK1j1Pf0Nc0dLMLgJ2IxZcU',
                range: 'Restaurants!A2:N',
				valueInputOption:'RAW',
                values: finalStatistics
            }).then(function(response) {
				console.log('write ok');
            }, function(response) {
                alert('Error: ' + response.result.error.message);
            });
        }

		//********************************************************************************************************
		//********************************************************************************************************
		//**										MAP RELATED METHODS											**
		//********************************************************************************************************
		//********************************************************************************************************
		
        function initMap() {
            var latlng = new google.maps.LatLng(10.31111, 123.89167);
            var mapOptions = {
                center: latlng,
                zoom: 16,
                scrollwheel: true,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                draggable: true
            }

            map = new google.maps.Map(document.getElementById('map'), mapOptions);
			ddlChart = document.getElementById('charting');
			
            directionsDisplay = new google.maps.DirectionsRenderer({
                map: map
            });

            currentLocation();
            insertDrawingManager();
            insertSearchbox();
            insertToggleRestaurants();
			insertDdl();
            addFunctionSearchbox();
            drawingManagerEvent();
            customFunction();
        }

		// HELPER METHODS
		function directionService() {
            var markerArray = [];
            var directionsService = new google.maps.DirectionsService;

            var stepDisplay = new google.maps.InfoWindow;
            directionsDisplay.setDirections({
                routes: []
            });

            calculateAndDisplayRoute(directionsDisplay, directionsService, markerArray, stepDisplay, map);

        }

        function calculateAndDisplayRoute(directionsDisplay, directionsService, markerArray, stepDisplay, map) {
            for (var i = 0; i < markerArray.length; i++) {
                markerArray[i].setMap(null);
            }

            directionsService.route({
                origin: currentPosition,
                destination: searchCoord,
                travelMode: 'WALKING'
            }, function(response, status) {
                // Route the directions and pass the response to a function to create
                // markers for each step.
                if (status === 'OK') {
                    document.getElementById('warnings-panel').innerHTML =
                        '<b>' + response.routes[0].warnings + '</b>';
                    directionsDisplay.setDirections(response);
                } else {
                    window.alert('Directions request failed due to ' + status);
                }
            });
        }

        function customFunction() {
            google.maps.Circle.prototype.contains = function(latLng) {
                return this.getBounds().contains(latLng) && google.maps.geometry.spherical.computeDistanceBetween(this.getCenter(), latLng) <= this.getRadius();
            }
        }
    
		function clearSelection() {
            if (selectedShape) {
                selectedShape.setEditable(false);
                selectedShape = null;
            }
        }

        function setSelection(shape) {
            populateMarkerInside(shape);
            clearSelection();
            selectedShape = shape;
            shape.setEditable(true);
        }

		function populateMarkerInside(shape) {
			var aa = 0;
			var bb = 0;
			var cc = 0;
			
            containedMarkers.length = [];
            for (var x = 0; x < nearbyMarkers.length; x++) {
                var m = nearbyMarkers[x].lss;
                if (shape.getBounds().contains(new google.maps.LatLng(m[2], m[3]))) {
					aa += m[4];
					bb += m[5]
					cc += m[6];
                    containedMarkers.push(m);
                }
            }
			
            alert('You have selected ' + containedMarkers.length + ' restaurants having an average revenues of ' + aa + ', average patrons/day of ' + bb + ' and average earnings/day of ' + cc) ;
        }

		function currentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    currentPosition = pos;
                    var marker = new google.maps.Marker;
                    marker.setMap(map);
                    marker.setPosition(pos);

                    map.setCenter(pos);
                }, function() {
                    handleLocationError(true, null, map.getCenter());
                });
            } else {
                // Browser doesn't support Geolocation
                handleLocationError(false, null, map.getCenter());
            }
        }

		function getRandomInt(min, max) {
			return Math.floor(Math.random() * (max - min + 1)) + min;
		}

        function createMarker(place) {
            var marker = new google.maps.Marker({
                map: map,
                position: place.geometry.location,
                icon: 'images/dinning.png',
                animation: google.maps.Animation.DROP
            });
			
			var localStoreStatistics = [];
			localStoreStatistics.push(place.id);
			localStoreStatistics.push(place.name);
			localStoreStatistics.push(place.geometry.location.lat());	// location
			localStoreStatistics.push(place.geometry.location.lng());	// location
			localStoreStatistics.push(getRandomInt(1, 6));	// classification
			localStoreStatistics.push(getRandomInt(100, 20000));	// revenues
			localStoreStatistics.push(getRandomInt(100, 20000));	// patrons/day
			localStoreStatistics.push(getRandomInt(100, 20000));	// earnings/day
			
			localStoreStatistics.push(getRandomInt(100, 20000));	// revenues (2015)
			localStoreStatistics.push(getRandomInt(100, 20000));	// patrons/day (2015)
			localStoreStatistics.push(getRandomInt(100, 20000));	// earnings/day (2015)
			
			localStoreStatistics.push(getRandomInt(100, 20000));	// revenues (2014)
			localStoreStatistics.push(getRandomInt(100, 20000));	// patrons/day (2014)
			localStoreStatistics.push(getRandomInt(100, 20000));	// earnings/day (2014)
			storeStatistics.push(localStoreStatistics);
			
			var nm = new Object();
			nm.lss = localStoreStatistics;
			nm.marker = marker;
			
            nearbyMarkers.push(nm);
			nearbyMarkerEvent(place, marker);
        }

		function cleanStoreArray() {
			
			if (fetchedStatistics.length == 0) {
				finalStatistics = storeStatistics.slice(0);
			}
			
			for(var x = 0; x<fetchedStatistics.length; x++) {
				var flag = false;
				var a = fetchedStatistics[0];
				for(var y = 0; y<storeStatistics.length; y++) {
					var b = storeStatistics[y];
					if (a[0] == b[0]) {
						flag = true;
						break;
					}
				}
				
				if (!flag) {
					finalStatistics.push(a);
				}
			}
			
		}
		
		function findPlace(place) {
			var z = [];
			for(var x = 0; x < finalStatistics.length; x++) {
				var y = finalStatistics[x];
				if (place.id == y[0]) {
					z = y;
					break;
				}
			}
			return z;
		}
		
		function identifyType(t) {
			switch(t) {
				case 1: return "Ethnic"; break;
				case 2: return "Fast Food"; break;
				case 3: return "Fast Casual"; break;
				case 4: return "Casual Dining"; break;
				case 5: return "Fine Dining"; break;
			}
			return "Ethnic";
		}
		
		// EVENTS
		function drawingManagerEvent() {
            google.maps.event.addListener(drawingManager, 'overlaycomplete', function(e) {
                all_overlays.push(e);
                if (e.type == google.maps.drawing.OverlayType.CIRCLE) {
                    drawingManager.setDrawingMode(null);

                    var newShape = e.overlay;
                    newShape.type = e.type;
                    google.maps.event.addListener(newShape, 'click', function() {
                        setSelection(newShape);
                    });

                    google.maps.event.addListener(newShape, "rightclick", function() {
                        this.setMap(null);
                    });

                    setSelection(newShape);
                }
            });
        }

		function showRestaurants() {
			classificationRestaurant.selectedIndex = 0;
			ddlChart.disabled=false;
            finalStatistics = [];
				handleAuthClick();
                var service = new google.maps.places.PlacesService(map);
                service.nearbySearch({
                    location: currentPosition,
                    radius: 500,
                    type: ['restaurant']
                }, callback);
				
			document.getElementById("classificationRestaurant").style.display = 'inline';
        }
		
		function callback(results, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
				checkAuth();
				storeStatistics = [];
                for (var i = 0; i < results.length; i++) {
                    createMarker(results[i]);
                }
				
				
				cleanStoreArray();
            }
        }

		function nearbyMarkerEvent(place, marker) {
            google.maps.event.addListener(marker, 'click', function() {
				var placeInfo = findPlace(place);
                var infowindow = new google.maps.InfoWindow();
				var content = '<div><div>'+place.name+'</div><div>'+identifyType(placeInfo[3])+'</div><div>Revenues:'+placeInfo[4]+'</div><div>Patrons/day:'+placeInfo[5]+'</div><div>Earnings/day:'+placeInfo[6]+'</div></div>';
                infowindow.setContent(content);
                infowindow.open(map, this);
                searchCoord = this.getPosition();
                directionService();
            });
		}
		
		function addFunctionSearchbox() {
            map.addListener('bounds_changed', function() {
                searchbox.setBounds(map.getBounds());
            });

            var markers = [];
            searchbox.addListener('places_changed', function() {
                var places = searchbox.getPlaces();
                if (places.length == 0) {
                    return;
                }

                markers.forEach(function(marker) {
                    marker.setMap(null);
                });
                markers = [];

                var bounds = new google.maps.LatLngBounds();
                places.forEach(function(place) {
                    if (!place.geometry) {
                        console.log("Returned place contains no geometry");
                        return;
                    }

                    var icon = {
                        url: place.icon,
                        size: new google.maps.Size(71, 71),
                        origin: new google.maps.Point(0, 0),
                        anchor: new google.maps.Point(17, 34),
                        scaledSize: new google.maps.Size(25, 25)
                    };

                    // Create a marker for each place.
                    markers.push(new google.maps.Marker({
                        map: map,
                        icon: icon,
                        title: place.name,
                        position: place.geometry.location,
                        animation: google.maps.Animation.DROP
                    }));

                    searchCoord = place.geometry.location;
                    if (place.geometry.viewport) {
                        // Only geocodes have viewport.
                        bounds.union(place.geometry.viewport);
                    } else {
                        bounds.extend(place.geometry.location);
                    }

                });
                directionService();
                map.fitBounds(bounds);
            });
        }
		
		// SETUP CUSTOM OBJECTS IN THE MAP
		function insertSearchbox() {
            searchbox = new google.maps.places.SearchBox(document.getElementById('searchbox'));
            map.controls[google.maps.ControlPosition.TOP_CENTER].push(document.getElementById('searchbox'));
        }

        function insertToggleRestaurants() {
            toggleRestaurant = document.getElementById('toggleNearbyRestaurant');
            map.controls[google.maps.ControlPosition.TOP_RIGHT].push(document.getElementById('toggleNearbyRestaurant'));
        }

		function insertDrawingManager() {
            drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: null,
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: ['circle']
                }
            });

            drawingManager.setMap(map);
        }
		
		function insertDdl() {
            ddl = document.getElementById('classificationRestaurant');
            map.controls[google.maps.ControlPosition.TOP_RIGHT].push(document.getElementById('classificationRestaurant'));
        }
		
		function onChangeDDL() {
			for(var i=0;i<nearbyMarkers.length;i++) {
				var marker = nearbyMarkers[i].marker;
				var data = nearbyMarkers[i].lss;
				if (ddl.options[ddl.selectedIndex].value == "0") {
					marker.setMap(map);
				} else {
					if (data[4] != parseInt(ddl.options[ddl.selectedIndex].value)) marker.setMap(null);
					else marker.setMap(map);
				}
				
			}
		}
		
		function onChangeChart() {
			switch(ddlChart.options[ddlChart.selectedIndex].value) {
				case "1": drawAreaChart(); break;
				case "2": drawLineChart(); break;
				case "3": drawPieChart(); break;
				case "4": drawComboChart(); break;
			}
		}
		
		function drawComboChart() {
			var arrToChart = [];
			
			for(var i=0; i< nearbyMarkers.length; i++) {
				var arrData = [];
				var data = nearbyMarkers[i].lss;
				arrData.push(parseInt(data[6]));
				arrData.push(parseInt(data[9]));
				arrData.push(parseInt(data[12]));
				arrData.unshift(data[1]);
				arrToChart.push(arrData);
			}
			
			arrToChart.unshift(chartHead);
			var data = google.visualization.arrayToDataTable(arrToChart);

			var options = {
			  title : "Restaurant's Patrons/day",
			  vAxis: {title: '1'},
			  hAxis: {title: '2'},
			  seriesType: 'bars',
			  series: {5: {type: 'line'}}
			};

			var chart = new google.visualization.ComboChart(document.getElementById('chart_div'));
			chart.draw(data, options);
		}
		
		
		function drawPieChart() {
			var arrToChart = [];
			var types1 = ['Ethnic', 0];
			var types2 = ['Fast Food', 0];
			var types3 = ['Fast Casual', 0];
			var types4 = ['Casual Dining', 0];
			var types5 = ['Fine Dining', 0];
			
			var pieHeader = ['Type', 'No. of restaurant type'];
			
			for(var i=0; i< nearbyMarkers.length; i++) {
				var data = nearbyMarkers[i].lss;
				switch(parseInt(data[4])) {
					case 1: types1[1]++; break;
					case 2: types2[1]++; break;
					case 3: types3[1]++; break;
					case 4: types4[1]++; break;
					case 5: types5[1]++; break;
				}
			}
			
			arrToChart.push(pieHeader);
			arrToChart.push(types1);
			arrToChart.push(types2);
			arrToChart.push(types3);
			arrToChart.push(types4);
			arrToChart.push(types5);
			var data = google.visualization.arrayToDataTable(arrToChart);

			var options = {
			  title: 'Types of nearby restaurants'
			};

			var chart = new google.visualization.PieChart(document.getElementById('chart_div'));
			chart.draw(data, options);
		}
		
		function drawLineChart() {
			var arrToChart = [];
			
			for(var i=0; i< nearbyMarkers.length; i++) {
				var arrData = [];
				var data = nearbyMarkers[i].lss;
				arrData.push(parseInt(data[5]));
				arrData.push(parseInt(data[8]));
				arrData.push(parseInt(data[11]));
				arrData.unshift(data[1]);
				arrToChart.push(arrData);
			}
			
			arrToChart.unshift(chartHead);
			var data = google.visualization.arrayToDataTable(arrToChart);

			var options = {
			  title: "Restaurant's revenues",
			  curveType: 'function',
			  legend: { position: 'bottom' }
			};

			var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
			chart.draw(data, options);
		}
		
		function drawAreaChart() {
			var arrToChart = [];
			
			for(var i=0; i< nearbyMarkers.length; i++) {
				var arrData = [];
				var data = nearbyMarkers[i].lss;
				arrData.push(parseInt(data[7]));
				arrData.push(parseInt(data[10]));
				arrData.push(parseInt(data[13]));
				arrData.unshift(data[1]);
				arrToChart.push(arrData);
			}
			
			arrToChart.unshift(chartHead);
			var data = google.visualization.arrayToDataTable(arrToChart);

			var options = {
			  title: "Restaurant's average earnings",
			  hAxis: {title: 'aw',  titleTextStyle: {color: '#333'}},
			  vAxis: {minValue: 0}
			};

			var chart = new google.visualization.AreaChart(document.getElementById('chart_div'));
			chart.draw(data, options);
		}


	</script>
    <script src="https://apis.google.com/js/client.js?">
    </script>
</head>

<body>
    <div id="map"></div>
    <input id="searchbox" class="controls" type="text" placeholder="Search Box" />
    <div id="warnings-panel"></div>
    <div id="panelToggle">
        <button type="button" id="toggleNearbyRestaurant" onClick="showRestaurants()">Show Restaurants</button>
		<select id="classificationRestaurant" onChange="onChangeDDL()" style="display: none;">
		  <option value="0">All
		  <option value="1">Ethnic
		  <option value="2">Fast Food
		  <option value="3">Fast Casual
		  <option value="4">Casual Dining
		  <option value="5">Fine Dining
		</select>
    </div>

    <div id="authorize-div" style="display: none">
        <span>Authorize access to Google Sheets API</span>
    </div>
	
	<div style="width: 100%; text-align: center;">
		<div style="margin: 0 auto; width: 50%; display: inline-block;">
			<select id="charting" onChange="onChangeChart()" disabled=true>
			  <option value="0">None
			  <option value="1">Average earnings (Area chart)
			  <option value="2">Revenues (Line chart)
			  <option value="3">Type (Pie chart)
			  <option value="4">Patrons/day (Column chart)
			</select>
		</div>
		
		<div style="margin: 0 auto; width: 50%; display: inline-block;">
			<div id='chart_div' style='width: 900px; height: 500px;'></div>
		</div>
	</div>
	
    <pre id="output"></pre>
    <script src="https://maps.googleapis.com/maps/api/js?&libraries=drawing,geometry,visualization,places&key=AIzaSyAFVvjEQ1yadVbzSLf4sOwG0Kg_wdqL1w0&callback=initMap" async defer></script>
	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
	<script type="text/javascript" src="https://www.google.com/jsapi"></script>
	<script type="text/javascript">google.load('visualization', '1.0', {'packages':['corechart']});</script>
</body>

</html>